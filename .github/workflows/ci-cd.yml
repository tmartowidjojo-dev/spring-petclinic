name: Spring Petclinic CI/CD (Java 25, Cached)

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1️ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️ Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 3️ Set up Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      # 4️ Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.9'

      # 5️ Build and run unit/integration tests
      - name: Build and test
        run: mvn clean verify

      # 6️ Start Spring Petclinic in the background
      - name: Start Spring Petclinic
        run: |
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo $! > spring-petclinic.pid
          
          echo "Waiting for Spring Petclinic to be ready..."
          until curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; do
            sleep 5
          done
          echo "Spring Petclinic is up!"

      # 7️ Install JMeter
      - name: Install JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y jmeter

      # 8️ Run JMeter Test and fail if there are errors
      - name: Run JMeter Test
        run: |
          jmeter -n -t performance-tests/petclinic-jmeter-test.jmx -l jmeter-results.jtl
          ERRORS=$(grep -c 'false' jmeter-results.jtl || true)
          if [ "$ERRORS" -gt 0 ]; then
            echo "JMeter test failed with $ERRORS errors"
            exit 1
          fi

      # 9️ Install k6 & jq
      - name: Install k6 & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:loadimpact/k6
          sudo apt-get update
          sudo apt-get install -y k6 jq

      # 10 Run k6 Test (fails automatically if thresholds violated)
      - name: Run k6 Test
        run: k6 run performance-tests/petclinic-load-test.js --out json=k6-results.json

      # 1️1️ Compare performance metrics
      - name: Compare JMeter & k6 metrics
        run: |
          echo "=== Performance Comparison ==="

          # --- JMeter metrics ---
          JM_TOTAL=$(grep -c '<httpSample' jmeter-results.jtl)
          JM_FAILED=$(grep -c 'false' jmeter-results.jtl || true)
          JM_AVG=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | awk '{sum+=$1; count++} END {print count ? sum/count : 0}')
          JM_MIN=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | sort -n | head -1)
          JM_MAX=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | sort -n | tail -1)

          # --- k6 metrics ---
          K6_TOTAL=$(jq '.metrics.http_reqs.count' k6-results.json)
          K6_FAILED=$(jq '.metrics.checks.failed' k6-results.json)
          K6_AVG=$(jq '.metrics.response_time.avg' k6-results.json)
          K6_MIN=$(jq '.metrics.response_time.min' k6-results.json)
          K6_MAX=$(jq '.metrics.response_time.max' k6-results.json)

          # --- Print table ---
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" Tool Total Failed Avg(ms) Min(ms) Max(ms)
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" JMeter $JM_TOTAL $JM_FAILED $JM_AVG $JM_MIN $JM_MAX
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" k6 $K6_TOTAL $K6_FAILED $K6_AVG $K6_MIN $K6_MAX

      # 1️2️ Upload performance artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            jmeter-results.jtl
            k6-results.json
            app.log

      # 1️3️ Stop Spring Petclinic
      - name: Stop Spring Petclinic
        if: always()
        run: |
          PID=$(cat spring-petclinic.pid)
          echo "Stopping Spring Petclinic (PID=$PID)..."
          kill $PID || true
          pkill -P $PID || true

          PID=$(cat spring-petclinic.pid)
          echo "Stopping Spring Petclinic (PID=$PID)..."
          kill $PID || true
          pkill -P $PID || true

