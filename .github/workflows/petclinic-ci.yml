name: Spring Petclinic CI/CD (Java 25)

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1️ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️ Set up Java 25
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      # 3️ Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.9'

      # 4️ Build and run unit/integration tests
      - name: Build and test
        run: mvn clean verify

      # 5️ Start Spring Petclinic in the background
      - name: Start Spring Petclinic
        run: |
          # The artifact will be named 'target/*.jar'
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo $! > spring-petclinic.pid
          echo "Waiting for Spring Petclinic to be ready..."
          until curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; do
            sleep 5
          done
          echo "Spring Petclinic is up!"

      # 6️ Install Performance Tools (Gecombineerd JMeter, k6 & jq)
      - name: Install Performance Tools (JMeter, k6, jq)
        run: |
          # Installeer basis tools en JMeter
          sudo apt-get update
          sudo apt-get install -y jmeter curl gnupg jq

          # Installeer k6
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y k6

          jmeter --version
          k6 version
          jq --version

      # 7️ Run Tests and Compare Metrics (Defensieve checks toegevoegd + DEBUGGING)
      - name: Run Tests and Compare Metrics
        run: |
          echo "===  Running JMeter Test ==="
          
          #  DEBUG: Gebruik de -j optie om een JMeter log file te genereren
          # JMeter wordt uitgevoerd met de log level ingesteld op DEBUG voor maximale info.
          jmeter -n -t performance-tests/petclinic-jmeter-test.jmx -l jmeter-results.jtl -j jmeter.log -LDEBUG
          
          # Controleer de exit code van de JMeter-opdracht 
          if [ $? -ne 0 ]; then
            echo "FATAL ERROR: JMeter test run failed with a non-zero exit code. Bekijk jmeter.log voor details."
            # We exit hier niet om de k6 test en artifact upload van de logs toe te staan
            # Zodat je de logboeken kunt downloaden om het probleem te vinden.
          fi

          # Controleer of het resultatenbestand daadwerkelijk bestaat 
          if [ ! -f "jmeter-results.jtl" ]; then
            echo "FATAL ERROR: jmeter-results.jtl file was NOT created. De JMeter test is mislukt."
            # We zetten JM_TOTAL, JM_FAILED, etc. op 0 of N/A om de rest van het script te laten draaien
            # Omdat we weten dat het hier fout gaat, moeten we de shell variablen leeg laten om de grep error te omzeilen.
            JM_TOTAL=0
            JM_FAILED=0
            JM_AVG=0
            JM_MIN=0
            JM_MAX=0
            
            # Sla de rest van de JMeter logica over
            SKIP_JMETERS_ANALYSE=true
          else
            # Functionele fouten controle (wordt alleen uitgevoerd als het bestand bestaat)
            JM_ERRORS=$(grep -c 'false' jmeter-results.jtl || echo 0)
            
            if [ "$JM_ERRORS" -gt 0 ]; then
              echo "JMeter test failed with $JM_ERRORS functional errors."
            fi
            echo "JMeter test completed successfully."

            # --- JMeter metrics (Alleen parsen als het bestand bestaat) ---
            JM_TOTAL=$(grep -c '<httpSample' jmeter-results.jtl)
            JM_FAILED=$JM_ERRORS
            JM_AVG=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | awk '{sum+=$1; count++} END {print count ? sum/count : 0}')
            JM_MIN=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | sort -n | head -1)
            JM_MAX=$(grep -oP ' t="\K[0-9]+' jmeter-results.jtl | sort -n | tail -1)
          fi
          
          echo "===  Running k6 Test ==="
          k6 run performance-tests/petclinic-load-test.js --out json=k6-results.json

          echo "=== Performance Comparison ==="
          
          # --- k6 metrics ---
          # We gaan ervan uit dat k6-results.json wel is aangemaakt, anders faalt jq hier (wat een minder ernstig probleem is)
          K6_TOTAL=$(jq '.metrics.http_reqs.count' k6-results.json || echo 0)
          K6_FAILED=$(jq '.metrics.checks.fails' k6-results.json || echo 0)
          K6_AVG=$(jq '.metrics.http_req_duration.avg * 1000' k6-results.json | cut -d'.' -f1 || echo 0)
          K6_MIN=$(jq '.metrics.http_req_duration.min * 1000' k6-results.json | cut -d'.' -f1 || echo 0)
          K6_MAX=$(jq '.metrics.http_req_duration.max * 1000' k6-results.json | cut -d'.' -f1 || echo 0)

          # --- Print table ---
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" Tool Total Failed Avg(ms) Min(ms) Max(ms)
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" JMeter $JM_TOTAL $JM_FAILED $JM_AVG $JM_MIN $JM_MAX
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" k6 $K6_TOTAL $K6_FAILED $K6_AVG $K6_MIN $K6_MAX

      # 8️ Upload performance artifacts (jmeter.log toegevoegd)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            jmeter-results.jtl
            k6-results.json
            app.log
            jmeter.log #  NIEUW: Voeg het JMeter logboek toe

      # 9️ Stop Spring Petclinic (Runs even if previous steps fail)
      - name: Stop Spring Petclinic
        if: always()
        run: |
          PID=$(cat spring-petclinic.pid)
          echo "Stopping Spring Petclinic (PID=$PID)..."
          kill $PID || true
          pkill -P $PID || true
