name: Spring Petclinic CI/CD (Java 25)
on:
  push:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è Set up Java 25
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          
      # 3Ô∏è Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.9'
          
      # 4Ô∏è Build and run unit/integration tests
      - name: Build and test
        run: mvn clean verify
        
      # 5Ô∏è Start Spring Petclinic in the background
      - name: Start Spring Petclinic
        run: |
          # The artifact will be named 'target/*.jar'
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo $! > spring-petclinic.pid
          echo "Waiting for Spring Petclinic to be ready..."
          until curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; do
            sleep 5
          done
          echo "Spring Petclinic is up!"
          
      # 6Ô∏è Install Performance Tools (k6 & jq)
      - name: Install Performance Tools (k6, jq)
        run: |
          # Installeer basis tools en jq
          sudo apt-get update
          sudo apt-get install -y curl gnupg jq
          
          # Installeer k6
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y k6
          
          k6 version
          jq --version
          
      # 7Ô∏è Run k6 Test and Display Metrics üöÄ
      - name: Run k6 Test and Display Metrics
        run: |
          echo "=== Running k6 Performance Test ==="
          k6 run performance-tests/petclinic-load-test.js --out json=k6-results.json
          echo "=== k6 Performance Metrics ==="
          
          # --- k6 metrics ---
          K6_TOTAL=$(jq '.metrics.http_reqs.count // 0' k6-results.json || echo 0)
          K6_FAILED=$(jq '.metrics.checks.fails // 0' k6-results.json || echo 0)
          
          # Conversie van seconden naar milliseconden en afronding naar geheel getal
          K6_AVG=$(jq '.metrics.http_req_duration.avg // 0 * 1000' k6-results.json | cut -d'.' -f1 || echo 0)
          K6_MIN=$(jq '.metrics.http_req_duration.min // 0 * 1000' k6-results.json | cut -d'.' -f1 || echo 0)
          K6_MAX=$(jq '.metrics.http_req_duration.max // 0 * 1000' k6-results.json | cut -d'.' -f1 || echo 0)
          
          # --- Print table ---
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" Tool Total Failed "Avg(ms)" "Min(ms)" "Max(ms)"
          printf "%-10s | %-10s | %-10s | %-10s | %-10s | %-10s\n" k6 $K6_TOTAL $K6_FAILED $K6_AVG $K6_MIN $K6_MAX
          
      # 8Ô∏è Upload performance artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            k6-results.json
            app.log
            
      # 9Ô∏è Stop Spring Petclinic (Runs even if previous steps fail)
      - name: Stop Spring Petclinic
        if: always()
        run: |
          PID=$(cat spring-petclinic.pid)
          echo "Stopping Spring Petclinic (PID=$PID)..."
          kill $PID || true
          pkill -P $PID || true
