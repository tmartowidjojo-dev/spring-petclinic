name: Spring Petclinic CI/CD
on:
  push:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1️ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️ Set up Java 25
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      # 3️ Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.9'

      # 4️ Compile and Package Petclinic JAR

      - name: Compile and Package Petclinic JAR
        run: |
          # Wis de lokale Maven repository voor dit project 
          rm -rf ~/.m2/repository/org/springframework/samples/petclinic
          
          # 2. Verwijder de oude target map
          rm -rf target 
          
          # 3. Compileer de nieuwe JAR
          # clean: wist target opnieuw
          # package: bouwt de JAR
          # -DskipTests: slaat de lange unittests over
          # -U: forceert update van snapshots
          ./mvnw clean package -DskipTests -U 

      # 5️ Start Spring Petclinic in de background
      - name: Start Spring Petclinic
        run: |
          # De JAR wordt uitgevoerd (met 200 VUs belasting)
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo $! > spring-petclinic.pid
          echo "Waiting for Spring Petclinic to be ready..."
          until curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; do
            sleep 5
          done
          echo "Spring Petclinic is up!"
            sleep 5

      # 6️ Install Performance Tools (k6 & jq)
      - name: Install Performance Tools (k6, jq)
        run: |
          # Installeer k6
          sudo apt-get update
          sudo apt-get install -y curl gnupg jq
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y k6
          
          
          # 7a. TEST 1: LOAD TEST 
          - name:  1. Run Load Test
            run: |
              echo "=== Start Load Test (20 Users) ==="
              k6 run performance-tests/petclinic-load-test.js --out json=load-results.json
          
          # 7b. TEST 2: STRESS TEST 
          - name:2. Run Stress Test 
            if: success()
            continue-on-error: true
            run: |
              echo "=== Start Stress Test (200 Users) ==="
              k6 run performance-tests/stress-test.js --out json=stress-results.json
          
          # 7c. TEST 3: BREAKPOINT TEST
          - name: 3. Run Breakpoint Test (Ramping)
            if: success() || failure()
            continue-on-error: true
            run: |
              echo "=== Start Breakpoint Test ==="
              k6 run performance-tests/breakpoint-test.js --out json=break-results.json

      # 8️ Upload performance artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            stress-results.json
            break-results.json
            k6-results.json
            app.log

      # 9️ Stop Spring Petclinic
      - name: Stop Spring Petclinic
        if: always()
        run: |
          PID=$(cat spring-petclinic.pid)
          echo "Stopping Spring Petclinic (PID=$PID)..."
          kill $PID || true
          pkill -P $PID || true
